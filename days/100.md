# Create and Configure Alarm Using CloudWatch Using Terraform

The Nautilus DevOps team has been tasked with setting up an EC2 instance for their application. To ensure the application performs optimally, they also need to create a CloudWatch alarm to monitor the instance's CPU utilization. The alarm should trigger if the CPU utilization exceeds 90% for one consecutive 5-minute period. To send notifications, use the SNS topic named nautilus-sns-topic, which is already created.

1. Launch EC2 Instance: Create an EC2 instance named `nautilus-ec2` using any appropriate Ubuntu AMI (you can use AMI `ami-0c02fb55956c7d316`).

2. Create CloudWatch Alarm: Create a CloudWatch alarm named `nautilus-alarm` with the following specifications:

    - Statistic: `Average`
    - Metric: `CPU Utilization`
    - Threshold: `>= 90%` for `1` consecutive `5-minute` period
    - Alarm Actions: Send a notification to the `nautilus-sns-topic` SNS topic.
3. Update the `main.tf` file (do not create a separate .tf file) to create a EC2 Instance and CloudWatch Alarm.

4. Create an `outputs.tf` file to output the following values:

    - `KKE_instance_name` for the EC2 instance name.
    - `KKE_alarm_name` for the CloudWatch alarm name.

Notes:

1. The Terraform working directory is /home/bob/terraform.

2. Right-click under the EXPLORER section in VS Code and select Open in Integrated Terminal to launch the terminal.

3. Before submitting the task, ensure that terraform plan returns No changes. Your infrastructure matches the configuration.

## Steps

1. Create a `variables.tf` file with these contents:

    ```hcl
    variable "prefix" {
        default = "nautilus"
    }
    ```

    > Replace `nautilus` according to your task description

2. Create a `main.tf` file with these contents:

    ```hcl
    resource "aws_sns_topic" "sns_topic" {
        name = "${var.prefix}-sns-topic"
    }

    resource "aws_instance" "ec2_instance" {
        ami = "ami-0c02fb55956c7d316"
        instance_type = "t2.micro"

        tags = {
            Name = "${var.prefix}-ec2"
        }
    }

    resource "aws_cloudwatch_metric_alarm" "cw_alarm" {
        alarm_name = "${var.prefix}-alarm"
        comparison_operator = "GreaterThanOrEqualToThreshold"
        evaluation_periods = 1
        metric_name = "CPUUtilization"
        namespace = "AWS/EC2"
        period = 300
        statistic = "Average"
        threshold = 90

        dimensions = {
            InstanceId = aws_instance.ec2_instance.id
        }

        alarm_actions = [aws_sns_topic.sns_topic.arn]
    }
    ```

    > There is a complete terraform file: [main.tf](../files/terraform_cloudwatch_alarm_on_ec2_instance_100.tf) with vpc, subnet, igw, route table, security group, ec2 key pair, sns topic and cloudwatch alarm. You can give it a look.

3. Create an `outputs.tf` file with these contents:

    ```hcl
    output "KKE_instance_name" {
        value = aws_instance.ec2_instance.tags["Name"]
    }

    output "KKE_alarm_name" {
        value = aws_cloudwatch_metric_alarm.cw_alarm.alarm_name
    }
    ```

4. Run the terraform commands:

    ```sh
    terraform init
    terraform plan
    terraform apply -auto-approve
    ```

## Youtube Video

- Watch Youtube Video: [https://youtu.be/UED-vxjxXuM](https://youtu.be/UED-vxjxXuM)

## Referrence

- [Cloud Watch Alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm)
- [Click to Start your 100 Days Challenge](https://linkly.link/2CeSH)

## Good To Know

### CloudWatch Alarm Configuration

- **Period vs Evaluation**: Period (300s = 5 minutes) is data collection interval, evaluation_periods (1) is how many periods to check
- **Threshold Logic**: `GreaterThanOrEqualToThreshold` with threshold `90` means CPU >= 90%
- **Statistic Types**: `Average`, `Maximum`, `Minimum`, `Sum`, `SampleCount` - Average is most common for CPU
- **Dimensions**: Must match exact case - use `InstanceId` not `instanceId` for EC2 instances

### EC2 Instance Monitoring

- **Default Metrics**: Basic monitoring (5-minute intervals) is free, detailed monitoring (1-minute) costs extra
- **Common Metrics**: `CPUUtilization`, `NetworkIn`, `NetworkOut`, `DiskReadOps`, `DiskWriteOps`
- **Instance Requirements**: CloudWatch agent needed for memory, disk space, and custom metrics
- **AMI Selection**: Use region-appropriate AMIs - `ami-0c02fb55956c7d316` is for us-east-1

### SNS Topic Integration

- **Alarm Actions**: Can trigger SNS, Auto Scaling, EC2 actions, or Systems Manager actions
- **Topic ARN**: Use `aws_sns_topic.name.arn` to reference topic ARN in alarm actions
- **Notification Types**: Email, SMS, HTTP/HTTPS endpoints, Lambda functions
- **Multiple Actions**: Single alarm can trigger multiple SNS topics or actions

### Terraform Best Practices

- **Resource Naming**: Use consistent naming with variables for reusability
- **Default VPC**: EC2 instances use default VPC/subnet when not specified
- **Output Values**: Reference resource attributes like `tags["Name"]` for dynamic outputs
- **Variable Defaults**: Set sensible defaults in variables.tf for easier reuse

### Monitoring Thresholds

- **CPU Utilization**: 90% is high threshold for alerts, consider 70-80% for warnings
- **Evaluation Periods**: Single period (1) for immediate alerts, multiple periods (2-3) to avoid false positives
- **Time Windows**: 5-minute periods balance responsiveness with stability
- **Alarm States**: OK, ALARM, INSUFFICIENT_DATA - plan for all states

### Common Issues & Solutions

- **Missing Metrics**: Ensure EC2 instance is running and has proper IAM permissions
- **Dimension Mismatch**: Verify InstanceId matches exactly (case-sensitive)
- **SNS Permissions**: CloudWatch needs permission to publish to SNS topic
- **Region Consistency**: All resources must be in same AWS region

### Production Considerations

- **Alarm Fatigue**: Set appropriate thresholds to avoid too many false alarms
- **Escalation**: Consider multiple alarm levels (warning, critical, emergency)
- **Documentation**: Tag resources and alarms for easy identification
- **Testing**: Verify alarm triggers work by temporarily lowering thresholds

